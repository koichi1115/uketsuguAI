# セットアップ手順書

## 1. 概要

本ドキュメントでは、受け継ぐAIの開発環境（MVP）のセットアップ手順を説明する。

### 1.1 前提条件
- Googleアカウント（GCP用）
- LINEアカウント（LINE Developers登録用）
- クレジットカード（GCP、LINE公式アカウント用）
- ローカル環境: Windows / macOS / Linux

### 1.2 必要なツール
- Google Cloud SDK（gcloud CLI）
- Git
- Python 3.11+
- PostgreSQL クライアント（psql）

---

## 2. GCPプロジェクト作成・初期設定

### 2.1 GCPプロジェクト作成

#### 2.1.1 Google Cloud Console にアクセス
1. https://console.cloud.google.com/ にアクセス
2. Googleアカウントでログイン

#### 2.1.2 新規プロジェクト作成
1. 画面上部の「プロジェクトを選択」をクリック
2. 「新しいプロジェクト」をクリック
3. プロジェクト情報を入力：
   - **プロジェクト名**: `uketsuguai-dev`（開発環境）
   - **プロジェクトID**: `uketsuguai-dev-xxxxx`（自動生成）
   - **場所**: 組織なし
4. 「作成」をクリック

#### 2.1.3 請求先アカウントの設定
1. 左メニュー「お支払い」→「請求先アカウントをリンク」
2. クレジットカード情報を登録
3. 無料トライアル（$300クレジット）を有効化

---

### 2.2 Google Cloud SDK のインストール

#### 2.2.1 Windows の場合
1. https://cloud.google.com/sdk/docs/install からインストーラーをダウンロード
2. インストーラーを実行
3. インストール後、PowerShell または コマンドプロンプトで確認：
   ```bash
   gcloud --version
   ```

#### 2.2.2 macOS の場合
```bash
# Homebrew でインストール
brew install google-cloud-sdk

# 確認
gcloud --version
```

#### 2.2.3 Linux の場合
```bash
# Debian/Ubuntu
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
sudo apt-get update && sudo apt-get install google-cloud-sdk

# 確認
gcloud --version
```

---

### 2.3 gcloud CLI の初期設定

```bash
# 認証
gcloud auth login

# プロジェクト設定
gcloud config set project uketsuguai-dev-xxxxx

# デフォルトリージョン設定
gcloud config set compute/region asia-northeast1
gcloud config set compute/zone asia-northeast1-a

# 設定確認
gcloud config list
```

---

### 2.4 必要なAPIの有効化

```bash
# Cloud SQL Admin API
gcloud services enable sqladmin.googleapis.com

# Cloud Functions API
gcloud services enable cloudfunctions.googleapis.com

# Cloud Build API
gcloud services enable cloudbuild.googleapis.com

# Secret Manager API
gcloud services enable secretmanager.googleapis.com

# Cloud Storage API
gcloud services enable storage-api.googleapis.com

# Vertex AI API（Gemini用）
gcloud services enable aiplatform.googleapis.com

# Cloud Scheduler API
gcloud services enable cloudscheduler.googleapis.com

# Cloud Logging API
gcloud services enable logging.googleapis.com

# Cloud Monitoring API
gcloud services enable monitoring.googleapis.com

# 有効化されたAPIを確認
gcloud services list --enabled
```

---

## 3. LINE公式アカウント作成

### 3.1 LINE Developersアカウント登録

#### 3.1.1 LINE Developersコンソールにアクセス
1. https://developers.line.biz/console/ にアクセス
2. LINEアカウントでログイン
3. 「プロバイダー」を作成
   - プロバイダー名: `uketsuguAI`

---

### 3.2 Messaging APIチャネル作成

#### 3.2.1 新規チャネル作成
1. プロバイダー `uketsuguAI` を選択
2. 「新規チャネル作成」→「Messaging API」を選択
3. チャネル情報を入力：
   - **チャネル名**: `受け継ぐAI（開発）`
   - **チャネル説明**: `死亡後の手続きをサポートするAIアシスタント`
   - **大業種**: `その他`
   - **小業種**: `その他`
   - **メールアドレス**: （自分のメールアドレス）
4. 利用規約に同意してチャネルを作成

#### 3.2.2 Webhook設定
1. チャネル設定画面で「Messaging API設定」タブを開く
2. 「Webhook URL」を一旦空欄のままにする（後でCloud FunctionsのURLを設定）
3. 「Webhookの利用」を**オン**にする
4. 「応答メッセージ」を**オフ**にする（ボットが自動応答を管理するため）
5. 「あいさつメッセージ」を**オフ**にする

#### 3.2.3 チャネルシークレット・アクセストークン取得
1. 「チャネル基本設定」タブ
   - **Channel Secret** をコピーしてメモ
2. 「Messaging API設定」タブ
   - **チャネルアクセストークン（長期）** の「発行」ボタンをクリック
   - 発行されたトークンをコピーしてメモ

⚠️ **重要**: Channel Secret とアクセストークンは外部に漏らさないこと

---

### 3.3 LINE公式アカウント設定（任意）

1. LINE Official Account Manager にアクセス
   - https://manager.line.biz/
2. プロフィール画像、説明文を設定
3. リッチメニューは後で設定

---

## 4. Cloud SQL セットアップ

### 4.1 Cloud SQLインスタンス作成

#### 4.1.1 コンソールから作成
1. Google Cloud Console → 「SQL」
2. 「インスタンスを作成」をクリック
3. 「PostgreSQL」を選択
4. インスタンス情報を入力：
   - **インスタンスID**: `uketsuguai-db-dev`
   - **パスワード**: （強力なパスワードを設定、メモしておく）
   - **データベースのバージョン**: PostgreSQL 15
   - **リージョン**: `asia-northeast1`（東京）
   - **ゾーンの可用性**: シングルゾーン（開発環境）

#### 4.1.2 マシン構成
1. 「マシンの構成をカスタマイズ」を選択
2. 「共有コア」→ `db-f1-micro`（1 vCPU、0.6 GB）
3. ストレージ: `10 GB`（SSD）
4. 自動ストレージ増加: **有効**

#### 4.1.3 接続設定
1. 「接続」セクション
2. 「パブリックIP」を**有効**にする（開発環境のみ）
3. 「承認済みネットワーク」を追加
   - ネットワーク名: `my-local`
   - IP範囲: 自分のIPアドレス（https://www.cman.jp/network/support/go_access.cgi で確認）

⚠️ **本番環境では Private IP を使用すること**

#### 4.1.4 バックアップ設定
1. 「バックアップ」を有効化
2. バックアップ時間: `04:00`（JST）
3. ポイントインタイムリカバリ: 有効

#### 4.1.5 作成
「作成」ボタンをクリック（作成に5〜10分かかる）

---

### 4.2 データベース作成

#### 4.2.1 Cloud SQLインスタンスに接続

**方法1: gcloud CLIで接続**
```bash
gcloud sql connect uketsuguai-db-dev --user=postgres
# パスワードを入力
```

**方法2: Cloud SQL Proxyで接続**
```bash
# Cloud SQL Proxyをダウンロード（初回のみ）
# Windows
curl -o cloud-sql-proxy.exe https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.x64.exe

# macOS/Linux
curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.darwin.amd64
chmod +x cloud-sql-proxy

# 接続
./cloud-sql-proxy uketsuguai-dev-xxxxx:asia-northeast1:uketsuguai-db-dev

# 別のターミナルで
psql "host=127.0.0.1 port=5432 sslmode=disable user=postgres dbname=postgres"
```

#### 4.2.2 データベース作成
```sql
-- データベース作成
CREATE DATABASE uketsuguai
    ENCODING 'UTF8'
    LC_COLLATE 'ja_JP.UTF-8'
    LC_CTYPE 'ja_JP.UTF-8';

-- データベース一覧確認
\l

-- データベースに接続
\c uketsuguai

-- タイムゾーン設定確認
SHOW timezone;
-- Asia/Tokyo でない場合は設定
ALTER DATABASE uketsuguai SET timezone TO 'Asia/Tokyo';
```

#### 4.2.3 アプリケーション用ユーザー作成
```sql
-- ユーザー作成
CREATE USER app_user WITH PASSWORD 'your_strong_password_here';

-- 権限付与
GRANT CONNECT ON DATABASE uketsuguai TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT CREATE ON SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO app_user;

-- 確認
\du
```

---

## 5. DDL実行（テーブル作成）

### 5.1 DDLスクリプトの準備

DDLスクリプトは `01_docs/03_データベース設計書.md` に記載されています。

#### 5.1.1 DDLファイル作成
1. `02_src/db/` ディレクトリを作成
2. `init.sql` ファイルを作成

**`02_src/db/init.sql`**:
```sql
-- UUID拡張機能
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- updated_at自動更新関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- users テーブル
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    line_user_id VARCHAR(255) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    last_login_at TIMESTAMP,
    is_deleted BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_line_user_id ON users(line_user_id);
CREATE INDEX idx_users_status ON users(status) WHERE is_deleted = false;

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- user_profiles テーブル
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    relationship VARCHAR(50),
    prefecture VARCHAR(50),
    municipality VARCHAR(100),
    death_date DATE,
    additional_info JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

CREATE TRIGGER update_user_profiles_updated_at BEFORE UPDATE ON user_profiles
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- subscriptions テーブル
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_type VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP,
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_stripe_customer_id ON subscriptions(stripe_customer_id);

CREATE TRIGGER update_subscriptions_updated_at BEFORE UPDATE ON subscriptions
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- tasks テーブル
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    priority VARCHAR(20) NOT NULL DEFAULT 'medium',
    due_date DATE,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    order_index INTEGER NOT NULL DEFAULT 0,
    metadata JSONB,
    is_deleted BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id) WHERE is_deleted = false;
CREATE INDEX idx_tasks_status ON tasks(status) WHERE is_deleted = false;
CREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE is_deleted = false;
CREATE INDEX idx_tasks_order ON tasks(user_id, order_index) WHERE is_deleted = false;

CREATE TRIGGER update_tasks_updated_at BEFORE UPDATE ON tasks
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- task_progress テーブル
CREATE TABLE task_progress (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL,
    note TEXT,
    completed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_task_progress_task_id ON task_progress(task_id);
CREATE INDEX idx_task_progress_created_at ON task_progress(created_at);

-- reminders テーブル
CREATE TABLE reminders (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    remind_at TIMESTAMP NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    sent_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reminders_task_id ON reminders(task_id);
CREATE INDEX idx_reminders_remind_at ON reminders(remind_at) WHERE status = 'pending';

-- conversation_history テーブル
CREATE TABLE conversation_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,
    message TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_conversation_history_user_id ON conversation_history(user_id);
CREATE INDEX idx_conversation_history_created_at ON conversation_history(created_at);

-- notifications テーブル
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    notification_type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT false,
    read_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id) WHERE is_read = false;
CREATE INDEX idx_notifications_created_at ON notifications(created_at);

-- knowledge_sources テーブル
CREATE TABLE knowledge_sources (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    source_type VARCHAR(50) NOT NULL,
    source_name VARCHAR(255) NOT NULL,
    url TEXT,
    content_hash TEXT NOT NULL,
    last_updated TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(source_type, source_name)
);

CREATE INDEX idx_knowledge_sources_source_type ON knowledge_sources(source_type);
CREATE INDEX idx_knowledge_sources_last_updated ON knowledge_sources(last_updated);
```

### 5.2 DDL実行

#### 5.2.1 psqlで実行
```bash
# Cloud SQL Proxyが起動している状態で
psql "host=127.0.0.1 port=5432 sslmode=disable user=postgres dbname=uketsuguai" -f 02_src/db/init.sql
```

#### 5.2.2 実行確認
```sql
-- テーブル一覧確認
\dt

-- users テーブルの構造確認
\d users

-- インデックス確認
\di
```

---

## 6. Secret Manager 設定

### 6.1 シークレット作成

```bash
# LINE_CHANNEL_SECRET
echo -n "YOUR_LINE_CHANNEL_SECRET" | gcloud secrets create LINE_CHANNEL_SECRET --data-file=-

# LINE_CHANNEL_ACCESS_TOKEN
echo -n "YOUR_LINE_CHANNEL_ACCESS_TOKEN" | gcloud secrets create LINE_CHANNEL_ACCESS_TOKEN --data-file=-

# DB_PASSWORD
echo -n "YOUR_DB_PASSWORD" | gcloud secrets create DB_PASSWORD --data-file=-

# GEMINI_API_KEY（後で取得）
echo -n "YOUR_GEMINI_API_KEY" | gcloud secrets create GEMINI_API_KEY --data-file=-

# シークレット一覧確認
gcloud secrets list
```

### 6.2 シークレットへのアクセス権限付与（後でCloud Functionsに付与）

---

## 7. 環境変数設定ファイル作成

### 7.1 `.env.example` 作成

**`03_config/.env.example`**:
```
# LINE
LINE_CHANNEL_SECRET=your_channel_secret_here
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here

# Cloud SQL
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=uketsuguai
DB_USER=app_user
DB_PASSWORD=your_db_password_here
DB_CONNECTION_NAME=uketsuguai-dev-xxxxx:asia-northeast1:uketsuguai-db-dev

# Gemini
GEMINI_API_KEY=your_gemini_api_key_here

# GCP
GCP_PROJECT_ID=uketsuguai-dev-xxxxx
GCP_REGION=asia-northeast1
```

### 7.2 `.env` 作成（実際の値を記入）

```bash
cd uketsuguAI
cp 03_config/.env.example 03_config/.env
# エディタで .env を編集して実際の値を記入
```

⚠️ `.env` は `.gitignore` に追加すること

---

## 8. Gemini API キー取得

### 8.1 Google AI Studio でAPI キー取得
1. https://aistudio.google.com/app/apikey にアクセス
2. 「APIキーを取得」をクリック
3. 既存のプロジェクト（`uketsuguai-dev`）を選択
4. APIキーをコピーしてメモ

### 8.2 Secret Manager に保存
```bash
echo -n "YOUR_GEMINI_API_KEY" | gcloud secrets create GEMINI_API_KEY --data-file=- --replication-policy="automatic"
```

---

## 9. ローカル開発環境セットアップ

### 9.1 Python環境構築

```bash
# Python 3.11 インストール確認
python3 --version

# 仮想環境作成
cd uketsuguAI/02_src
python3 -m venv venv

# 仮想環境アクティベート
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate

# 依存パッケージインストール（後で requirements.txt 作成）
pip install --upgrade pip
```

### 9.2 Cloud SQL Proxy 起動（ローカル開発用）

```bash
# バックグラウンドで起動
./cloud-sql-proxy uketsuguai-dev-xxxxx:asia-northeast1:uketsuguai-db-dev &

# 確認
psql "host=127.0.0.1 port=5432 sslmode=disable user=app_user dbname=uketsuguai"
```

---

## 10. 確認事項チェックリスト

セットアップが完了したら、以下を確認してください：

- [ ] GCPプロジェクト作成完了
- [ ] 必要なAPI有効化完了
- [ ] LINE Messaging APIチャネル作成完了
- [ ] Channel Secret、アクセストークン取得完了
- [ ] Cloud SQLインスタンス作成完了
- [ ] データベース `uketsuguai` 作成完了
- [ ] アプリケーションユーザー `app_user` 作成完了
- [ ] DDL実行、全テーブル作成完了
- [ ] Secret Manager にシークレット登録完了
- [ ] Gemini API キー取得完了
- [ ] `.env` ファイル作成完了
- [ ] Cloud SQL Proxy でローカル接続確認完了

---

## トラブルシューティング

### Cloud SQL 接続エラー

**エラー**: `connection refused`
- Cloud SQL インスタンスが起動しているか確認
- 承認済みネットワークに自分のIPが追加されているか確認
- Cloud SQL Proxy が正しく起動しているか確認

**エラー**: `password authentication failed`
- パスワードが正しいか確認
- ユーザー名が正しいか確認（`postgres` vs `app_user`）

### API有効化エラー

**エラー**: `API not enabled`
```bash
# 該当するAPIを有効化
gcloud services enable <api-name>.googleapis.com
```

### Secret Manager エラー

**エラー**: `Permission denied`
```bash
# 必要な権限を付与
gcloud projects add-iam-policy-binding uketsuguai-dev-xxxxx \
  --member="user:your-email@example.com" \
  --role="roles/secretmanager.admin"
```

---

## 付録

### 改訂履歴
| バージョン | 日付 | 変更内容 | 変更者 |
|---------|------|---------|--------|
| 1.0 | 2025-10-05 | 初版作成 | - |

---
作成日: 2025-10-05
最終更新: 2025-10-05
