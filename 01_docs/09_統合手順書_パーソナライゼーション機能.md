# ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ çµ±åˆæ‰‹é †æ›¸

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±
- **ä½œæˆæ—¥**: 2025-10-13
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
- **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: feature/improve-task-personalization

---

## ğŸ¯ çµ±åˆã®ç›®çš„

åŸºæœ¬ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆStep 1ï¼‰ã®å¾Œã«ã€è¿½åŠ è³ªå•ã‚’é€šã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ·±å €ã‚Šã—ã€å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆStep 2ï¼‰ã¨Tipsåé›†ï¼ˆStep 3ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹æ–°ã—ã„ãƒ•ãƒ­ãƒ¼ã‚’main.pyã«çµ±åˆã—ã¾ã™ã€‚

---

## ğŸ“ å®Ÿè£…æ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¾ã—ãŸï¼š

1. **question_generator.py** - è¿½åŠ è³ªå•ç”Ÿæˆãƒ»ç®¡ç†
2. **conversation_flow_manager.py** - ä¼šè©±çŠ¶æ…‹ç®¡ç†
3. **task_personalizer.py** - å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆStep 2ï¼‰
4. **task_enhancer.py** - Tipsåé›†ãƒ»æ‹¡å¼µï¼ˆStep 3ï¼‰
5. **001_add_personalization_tables.sql** - DBã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ

---

## ğŸ”„ æ–°ã—ã„ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åé›†å®Œäº†                            â”‚
â”‚  (relationship, prefecture, municipality, death_date) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: åŸºæœ¬ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆæ—¢å­˜ï¼‰                  â”‚
â”‚  â†’ generate_basic_tasks() in task_generator.py  â”‚
â”‚  â†’ Cloud TasksçµŒç”±ã§éåŒæœŸå®Ÿè¡Œ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºæœ¬ã‚¿ã‚¹ã‚¯ç”Ÿæˆå®Œäº†é€šçŸ¥                          â”‚
â”‚  + è¿½åŠ è³ªå•ã‚’ç”Ÿæˆ                               â”‚
â”‚  â†’ generate_follow_up_questions()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ è³ªå•ã«å›ç­”                        â”‚
â”‚  â†’ save_answer()                                â”‚
â”‚  â†’ ã™ã¹ã¦å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆ                          â”‚
â”‚  â†’ generate_personalized_tasks()                â”‚
â”‚  â†’ Cloud TasksçµŒç”±ã§éåŒæœŸå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Tipsåé›†ãƒ»æ‹¡å¼µ                          â”‚
â”‚  â†’ enhance_tasks_with_tips()                    â”‚
â”‚  â†’ Cloud TasksçµŒç”±ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ çµ±åˆæ‰‹é †

### æ‰‹é †1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLã‚’å®Ÿè¡Œ
psql -h <DB_HOST> -U <DB_USER> -d <DB_NAME> -f 02_src/db/migrations/001_add_personalization_tables.sql
```

ã¾ãŸã¯ã€Cloud SQL Proxyã‚’ä½¿ç”¨ï¼š

```bash
cloud_sql_proxy -instances=<CONNECTION_NAME>=tcp:5432 &
psql -h 127.0.0.1 -U <DB_USER> -d <DB_NAME> -f 02_src/db/migrations/001_add_personalization_tables.sql
```

### æ‰‹é †2: `generate_tasks_worker` ã®ä¿®æ­£

`main.py` ã® `generate_tasks_worker` é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ï¼š

```python
@functions_framework.http
def generate_tasks_worker(request: Request):
    """
    éåŒæœŸã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆStep 1: åŸºæœ¬ã‚¿ã‚¹ã‚¯ï¼‰

    Cloud Tasksã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€åŸºæœ¬ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã—ã¦Pushé€šçŸ¥ã™ã‚‹
    å®Œäº†å¾Œã€è¿½åŠ è³ªå•ã‚’ç”Ÿæˆã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
    """
    from task_generator import generate_basic_tasks, get_task_summary_message
    from question_generator import generate_follow_up_questions, format_question_for_line
    from conversation_flow_manager import ConversationFlowManager

    try:
        request_json = request.get_json(silent=True)
        if not request_json:
            return jsonify({"error": "Invalid request body"}), 400

        user_id = request_json.get('user_id')
        line_user_id = request_json.get('line_user_id')

        if not user_id or not line_user_id:
            return jsonify({"error": "user_id and line_user_id are required"}), 400

        print(f"ğŸ”„ Step 1: åŸºæœ¬ã‚¿ã‚¹ã‚¯ç”Ÿæˆé–‹å§‹: user_id={user_id}")

        engine = get_db_engine()

        # ä¼šè©±ãƒ•ãƒ­ãƒ¼ç®¡ç†åˆæœŸåŒ–
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(user_id, 'basic', 'in_progress')

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
        with engine.connect() as conn:
            profile_data = conn.execute(
                sqlalchemy.text(
                    """
                    SELECT relationship, prefecture, municipality, death_date
                    FROM user_profiles
                    WHERE user_id = :user_id
                    """
                ),
                {"user_id": user_id}
            ).fetchone()

            if not profile_data:
                print(f"âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {user_id}")
                return jsonify({"error": "User profile not found"}), 404

            profile = {
                'relationship': profile_data[0],
                'prefecture': profile_data[1],
                'municipality': profile_data[2],
                'death_date': profile_data[3]
            }

        # Step 1: åŸºæœ¬ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
        with engine.connect() as conn:
            tasks = generate_basic_tasks(user_id, profile, conn)

        print(f"âœ… Step 1å®Œäº†: {len(tasks)}ä»¶ã®åŸºæœ¬ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆ")

        # Step 1å®Œäº†ã‚’ãƒãƒ¼ã‚¯
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(
                user_id, 'basic', 'completed',
                metadata={'task_count': len(tasks)}
            )

        # è¿½åŠ è³ªå•ã‚’ç”Ÿæˆ
        with engine.connect() as conn:
            questions = generate_follow_up_questions(user_id, profile, tasks, conn)

        print(f"âœ… è¿½åŠ è³ªå•ç”Ÿæˆå®Œäº†: {len(questions)}ä»¶")

        # ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + è¿½åŠ è³ªå•
        municipality = profile['municipality']
        summary_message = get_task_summary_message(tasks, municipality)

        # è¿½åŠ è³ªå•ã®æœ€åˆã®è³ªå•ã‚’å–å¾—
        with engine.connect() as conn:
            first_question_data = conn.execute(
                sqlalchemy.text(
                    """
                    SELECT question_text, question_type, options
                    FROM follow_up_questions
                    WHERE user_id = :user_id AND is_answered = false
                    ORDER BY display_order
                    LIMIT 1
                    """
                ),
                {'user_id': user_id}
            ).fetchone()

        # LINE Push API ã§é€šçŸ¥
        configuration = get_configuration()
        with ApiClient(configuration) as api_client:
            line_bot_api = MessagingApi(api_client)

            messages = [TextMessage(text=summary_message)]

            if first_question_data:
                question_obj = {
                    'question_text': first_question_data[0],
                    'question_type': first_question_data[1],
                    'options': first_question_data[2]
                }
                question_message = format_question_for_line(question_obj)

                # Quick Replyã§è³ªå•
                quick_reply = QuickReply(
                    items=[
                        QuickReplyItem(action=MessageAction(label="ã¯ã„", text="ã¯ã„")),
                        QuickReplyItem(action=MessageAction(label="ã„ã„ãˆ", text="ã„ã„ãˆ"))
                    ]
                )

                messages.append(
                    TextMessage(
                        text=f"\n\nğŸ“ ã‚ˆã‚Šè©³ç´°ãªã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã€ã„ãã¤ã‹è³ªå•ã•ã›ã¦ãã ã•ã„ã€‚\n\n{question_message}",
                        quick_reply=quick_reply
                    )
                )

            line_bot_api.push_message(
                PushMessageRequest(
                    to=line_user_id,
                    messages=messages
                )
            )

        print(f"ğŸ“¤ Pushé€šçŸ¥é€ä¿¡å®Œäº†: line_user_id={line_user_id}")

        # ä¼šè©±çŠ¶æ…‹ã‚’ã€Œè¿½åŠ è³ªå•å¾…ã¡ã€ã«è¨­å®š
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_state(
                user_id,
                'awaiting_follow_up_answers',
                {'current_question_index': 0}
            )

        return jsonify({
            "status": "success",
            "user_id": user_id,
            "basic_tasks_count": len(tasks),
            "follow_up_questions_count": len(questions)
        }), 200

    except Exception as e:
        print(f"âŒ ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()

        # ã‚¨ãƒ©ãƒ¼æ™‚ã¯Step 1ã‚’failedã«ãƒãƒ¼ã‚¯
        if 'user_id' in locals():
            with engine.connect() as conn:
                flow_manager = ConversationFlowManager(conn)
                flow_manager.set_task_generation_step_status(
                    user_id, 'basic', 'failed',
                    error_message=str(e)
                )

        # ã‚¨ãƒ©ãƒ¼é€šçŸ¥
        try:
            if 'line_user_id' in locals() and line_user_id:
                configuration = get_configuration()
                with ApiClient(configuration) as api_client:
                    line_bot_api = MessagingApi(api_client)
                    line_bot_api.push_message(
                        PushMessageRequest(
                            to=line_user_id,
                            messages=[TextMessage(
                                text="âš ï¸ ã‚¿ã‚¹ã‚¯ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nãŠæ‰‹æ•°ã§ã™ãŒã€ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚"
                            )]
                        )
                    )
        except:
            pass

        return jsonify({"error": str(e)}), 500
```

### æ‰‹é †3: `handle_message` ã«è¿½åŠ è³ªå•å›ç­”å‡¦ç†ã‚’è¿½åŠ 

`process_profile_collection` é–¢æ•°å†…ã§è¿½åŠ è³ªå•ã¸ã®å›ç­”ã‚’å‡¦ç†ï¼š

```python
def process_profile_collection(user_id, line_user_id, message, relationship, prefecture, municipality, death_date):
    """ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åé›†å‡¦ç†"""
    engine = get_db_engine()

    from conversation_flow_manager import ConversationFlowManager
    from question_generator import (
        get_unanswered_questions,
        save_answer,
        check_all_questions_answered,
        format_question_for_line
    )

    with engine.connect() as conn:
        flow_manager = ConversationFlowManager(conn)
        current_state = flow_manager.get_current_state(user_id)

        # è¿½åŠ è³ªå•å›ç­”å¾…ã¡çŠ¶æ…‹ã®å ´åˆ
        if current_state == 'awaiting_follow_up_answers':
            # æœªå›ç­”ã®è³ªå•ã‚’å–å¾—
            questions = get_unanswered_questions(user_id, conn)

            if questions:
                # æœ€åˆã®æœªå›ç­”è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã¨ã—ã¦ä¿å­˜
                first_question = questions[0]
                save_answer(user_id, first_question['question_key'], message, conn)

                # ã¾ã æœªå›ç­”ã®è³ªå•ãŒã‚ã‚‹ã‹ç¢ºèª
                remaining_questions = get_unanswered_questions(user_id, conn)

                if remaining_questions:
                    # æ¬¡ã®è³ªå•ã‚’é€ä¿¡
                    next_question = remaining_questions[0]
                    question_message = format_question_for_line(next_question)

                    quick_reply = QuickReply(
                        items=[
                            QuickReplyItem(action=MessageAction(label="ã¯ã„", text="ã¯ã„")),
                            QuickReplyItem(action=MessageAction(label="ã„ã„ãˆ", text="ã„ã„ãˆ"))
                        ]
                    )

                    return {
                        "type": "text_with_quick_reply",
                        "text": question_message,
                        "quick_reply": quick_reply
                    }
                else:
                    # ã™ã¹ã¦ã®è³ªå•ã«å›ç­”å®Œäº†
                    # Step 2: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚’é–‹å§‹
                    flow_manager.clear_state(user_id, 'awaiting_follow_up_answers')

                    # Cloud Tasksã«å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥
                    enqueue_personalized_task_generation(user_id, line_user_id)

                    return """âœ… è³ªå•ã¸ã®ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

ğŸ¤– ã‚ãªãŸã®çŠ¶æ³ã«ç‰¹åŒ–ã—ãŸè¿½åŠ ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆä¸­ã§ã™...

â±ï¸ å®Œäº†ã—ãŸã‚‰é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚"""

    # æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åé›†ãƒ•ãƒ­ãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
    # ...ï¼ˆã“ã“ã«æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ï¼‰
```

### æ‰‹é †4: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 

æ–°ã—ã„Cloud Function / ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ï¼š

```python
@functions_framework.http
def personalized_tasks_worker(request: Request):
    """
    Step 2: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¯ãƒ¼ã‚«ãƒ¼

    Cloud Tasksã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€è¿½åŠ è³ªå•ã®å›ç­”ã«åŸºã¥ã„ã¦
    å€‹åˆ¥ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã™ã‚‹
    """
    from task_personalizer import generate_personalized_tasks
    from conversation_flow_manager import ConversationFlowManager
    from question_generator import get_user_answers

    try:
        request_json = request.get_json(silent=True)
        if not request_json:
            return jsonify({"error": "Invalid request body"}), 400

        user_id = request_json.get('user_id')
        line_user_id = request_json.get('line_user_id')

        if not user_id or not line_user_id:
            return jsonify({"error": "user_id and line_user_id are required"}), 400

        print(f"ğŸ”„ Step 2: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆé–‹å§‹: user_id={user_id}")

        engine = get_db_engine()

        # Step 2é–‹å§‹ã‚’ãƒãƒ¼ã‚¯
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(user_id, 'personalized', 'in_progress')

        # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨è¿½åŠ å›ç­”ã‚’å–å¾—
        with engine.connect() as conn:
            profile_data = conn.execute(
                sqlalchemy.text(
                    """
                    SELECT relationship, prefecture, municipality, death_date
                    FROM user_profiles
                    WHERE user_id = :user_id
                    """
                ),
                {"user_id": user_id}
            ).fetchone()

            profile = {
                'relationship': profile_data[0],
                'prefecture': profile_data[1],
                'municipality': profile_data[2],
                'death_date': profile_data[3]
            }

            additional_answers = get_user_answers(user_id, conn)

        # Step 2: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
        with engine.connect() as conn:
            personalized_tasks = generate_personalized_tasks(
                user_id, profile, additional_answers, conn
            )

        print(f"âœ… Step 2å®Œäº†: {len(personalized_tasks)}ä»¶ã®å€‹åˆ¥ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆ")

        # Step 2å®Œäº†ã‚’ãƒãƒ¼ã‚¯
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(
                user_id, 'personalized', 'completed',
                metadata={'task_count': len(personalized_tasks)}
            )

        # LINEé€šçŸ¥
        configuration = get_configuration()
        with ApiClient(configuration) as api_client:
            line_bot_api = MessagingApi(api_client)
            line_bot_api.push_message(
                PushMessageRequest(
                    to=line_user_id,
                    messages=[TextMessage(
                        text=f"âœ… ã‚ãªãŸå°‚ç”¨ã®è¿½åŠ ã‚¿ã‚¹ã‚¯ã‚’{len(personalized_tasks)}ä»¶ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nã€Œã‚¿ã‚¹ã‚¯ã€ã¨é€ä¿¡ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                    )]
                )
            )

        # Step 3: Tipsåé›†ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é–‹å§‹
        enqueue_tips_enhancement(user_id, line_user_id)

        return jsonify({
            "status": "success",
            "user_id": user_id,
            "personalized_tasks_count": len(personalized_tasks)
        }), 200

    except Exception as e:
        print(f"âŒ å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()

        if 'user_id' in locals():
            with engine.connect() as conn:
                flow_manager = ConversationFlowManager(conn)
                flow_manager.set_task_generation_step_status(
                    user_id, 'personalized', 'failed',
                    error_message=str(e)
                )

        return jsonify({"error": str(e)}), 500


@functions_framework.http
def tips_enhancement_worker(request: Request):
    """
    Step 3: Tipsåé›†ãƒ»æ‹¡å¼µãƒ¯ãƒ¼ã‚«ãƒ¼

    Cloud Tasksã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€æ—¢å­˜ã‚¿ã‚¹ã‚¯ã«SNSãƒ»ãƒ–ãƒ­ã‚°ã‹ã‚‰
    åé›†ã—ãŸTipsã‚’è¿½åŠ ã™ã‚‹
    """
    from task_enhancer import enhance_tasks_with_tips, generate_general_tips_task
    from conversation_flow_manager import ConversationFlowManager

    try:
        request_json = request.get_json(silent=True)
        if not request_json:
            return jsonify({"error": "Invalid request body"}), 400

        user_id = request_json.get('user_id')
        line_user_id = request_json.get('line_user_id')

        if not user_id or not line_user_id:
            return jsonify({"error": "user_id and line_user_id are required"}), 400

        print(f"ğŸ”„ Step 3: Tipsåé›†é–‹å§‹: user_id={user_id}")

        engine = get_db_engine()

        # Step 3é–‹å§‹ã‚’ãƒãƒ¼ã‚¯
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(user_id, 'enhanced', 'in_progress')

        # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        with engine.connect() as conn:
            profile_data = conn.execute(
                sqlalchemy.text(
                    "SELECT relationship, prefecture, municipality, death_date FROM user_profiles WHERE user_id = :user_id"
                ),
                {"user_id": user_id}
            ).fetchone()

            profile = {
                'relationship': profile_data[0],
                'prefecture': profile_data[1],
                'municipality': profile_data[2],
                'death_date': profile_data[3]
            }

        # Step 3: Tipsåé›†ãƒ»æ‹¡å¼µ
        with engine.connect() as conn:
            stats = enhance_tasks_with_tips(user_id, conn)
            generate_general_tips_task(user_id, profile, conn)

        print(f"âœ… Step 3å®Œäº†: {stats['enhanced_count']}ä»¶ã®ã‚¿ã‚¹ã‚¯ã«{stats['new_tips_count']}å€‹ã®Tipsã‚’è¿½åŠ ")

        # Step 3å®Œäº†ã‚’ãƒãƒ¼ã‚¯
        with engine.connect() as conn:
            flow_manager = ConversationFlowManager(conn)
            flow_manager.set_task_generation_step_status(
                user_id, 'enhanced', 'completed',
                metadata=stats
            )

        # LINEé€šçŸ¥
        configuration = get_configuration()
        with ApiClient(configuration) as api_client:
            line_bot_api = MessagingApi(api_client)
            line_bot_api.push_message(
                PushMessageRequest(
                    to=line_user_id,
                    messages=[TextMessage(
                        text=f"ğŸ’¡ ã‚¿ã‚¹ã‚¯ã«å®Ÿç”¨çš„ãªTipsã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\n\nä½“é¨“è«‡ã‚„è£æŠ€ã‚’å‚è€ƒã«ã—ã¦ã€ã‚¹ãƒ ãƒ¼ã‚ºã«æ‰‹ç¶šãã‚’é€²ã‚ã¦ãã ã•ã„ã€‚"
                    )]
                )
            )

        return jsonify({
            "status": "success",
            "user_id": user_id,
            "enhanced_count": stats['enhanced_count'],
            "new_tips_count": stats['new_tips_count']
        }), 200

    except Exception as e:
        print(f"âŒ Tipsåé›†ã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()

        if 'user_id' in locals():
            with engine.connect() as conn:
                flow_manager = ConversationFlowManager(conn)
                flow_manager.set_task_generation_step_status(
                    user_id, 'enhanced', 'failed',
                    error_message=str(e)
                )

        return jsonify({"error": str(e)}), 500
```

### æ‰‹é †5: Cloud Tasksã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼é–¢æ•°ã‚’è¿½åŠ 

```python
def enqueue_personalized_task_generation(user_id: str, line_user_id: str):
    """Cloud Tasksã«å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥"""
    client = tasks_v2.CloudTasksClient()
    queue_name = 'task-generation-queue'
    parent = client.queue_path(PROJECT_ID, REGION, queue_name)

    worker_url = f"https://{REGION}-{PROJECT_ID}.cloudfunctions.net/personalized-tasks-worker"

    payload = json.dumps({
        'user_id': str(user_id),
        'line_user_id': line_user_id
    }).encode()

    task = {
        'http_request': {
            'http_method': tasks_v2.HttpMethod.POST,
            'url': worker_url,
            'headers': {'Content-Type': 'application/json'},
            'body': payload,
            'oidc_token': {
                'service_account_email': 'webhook-handler@uketsuguai-dev.iam.gserviceaccount.com'
            }
        }
    }

    response = client.create_task(request={'parent': parent, 'task': task})
    print(f"ğŸ“¤ å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥: {response.name}")


def enqueue_tips_enhancement(user_id: str, line_user_id: str):
    """Cloud Tasksã«Tipsåé›†ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥"""
    client = tasks_v2.CloudTasksClient()
    queue_name = 'task-generation-queue'
    parent = client.queue_path(PROJECT_ID, REGION, queue_name)

    worker_url = f"https://{REGION}-{PROJECT_ID}.cloudfunctions.net/tips-enhancement-worker"

    payload = json.dumps({
        'user_id': str(user_id),
        'line_user_id': line_user_id
    }).encode()

    task = {
        'http_request': {
            'http_method': tasks_v2.HttpMethod.POST,
            'url': worker_url,
            'headers': {'Content-Type': 'application/json'},
            'body': payload,
            'oidc_token': {
                'service_account_email': 'webhook-handler@uketsuguai-dev.iam.gserviceaccount.com'
            }
        }
    }

    response = client.create_task(request={'parent': parent, 'task': task})
    print(f"ğŸ“¤ Tipsåé›†ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥: {response.name}")
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤

### Cloud Functionsãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# æ—¢å­˜ã®webhookã¨task-generator-workerã‚’æ›´æ–°
gcloud functions deploy webhook \
  --gen2 \
  --runtime=python311 \
  --region=asia-northeast1 \
  --source=./02_src/webhook-handler \
  --entry-point=webhook \
  --trigger-http \
  --allow-unauthenticated

gcloud functions deploy task-generator-worker \
  --gen2 \
  --runtime=python311 \
  --region=asia-northeast1 \
  --source=./02_src/webhook-handler \
  --entry-point=generate_tasks_worker \
  --trigger-http \
  --no-allow-unauthenticated

# æ–°è¦: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¯ãƒ¼ã‚«ãƒ¼
gcloud functions deploy personalized-tasks-worker \
  --gen2 \
  --runtime=python311 \
  --region=asia-northeast1 \
  --source=./02_src/webhook-handler \
  --entry-point=personalized_tasks_worker \
  --trigger-http \
  --no-allow-unauthenticated

# æ–°è¦: Tipsåé›†ãƒ¯ãƒ¼ã‚«ãƒ¼
gcloud functions deploy tips-enhancement-worker \
  --gen2 \
  --runtime=python311 \
  --region=asia-northeast1 \
  --source=./02_src/webhook-handler \
  --entry-point=tips_enhancement_worker \
  --trigger-http \
  --no-allow-unauthenticated
```

---

## âœ… ãƒ†ã‚¹ãƒˆæ‰‹é †

### 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```bash
pytest 04_tests/test_question_generator.py
pytest 04_tests/test_conversation_flow_manager.py
pytest 04_tests/test_task_personalizer.py
pytest 04_tests/test_task_enhancer.py
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

1. LINEã§botã‚’å‹ã ã¡è¿½åŠ 
2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²
3. åŸºæœ¬ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. è¿½åŠ è³ªå•ãŒå±Šãã“ã¨ã‚’ç¢ºèª
5. ã™ã¹ã¦ã®è³ªå•ã«å›ç­”
6. å€‹åˆ¥ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
7. TipsãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ãƒ­ã‚°ç¢ºèª

```bash
# Step 1ãƒ­ã‚°
gcloud functions logs read task-generator-worker --region=asia-northeast1 --limit=50

# Step 2ãƒ­ã‚°
gcloud functions logs read personalized-tasks-worker --region=asia-northeast1 --limit=50

# Step 3ãƒ­ã‚°
gcloud functions logs read tips-enhancement-worker --region=asia-northeast1 --limit=50
```

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¯ã‚¨ãƒª

```sql
-- å„ã‚¹ãƒ†ãƒƒãƒ—ã®é€²æ—ç¢ºèª
SELECT
  user_id,
  step_name,
  status,
  started_at,
  completed_at,
  metadata
FROM task_generation_steps
WHERE user_id = '<USER_ID>'
ORDER BY created_at DESC;

-- è¿½åŠ è³ªå•ã®å›ç­”çŠ¶æ³
SELECT
  question_text,
  is_answered,
  answer
FROM follow_up_questions
WHERE user_id = '<USER_ID>'
ORDER BY display_order;
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **APIè²»ç”¨**: 3ã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã€Gemini APIã®å‘¼ã³å‡ºã—ãŒå¢—åŠ ã—ã¾ã™ã€‚ã‚³ã‚¹ãƒˆã‚’ç›£è¦–ã—ã¦ãã ã•ã„ã€‚

2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: Cloud Functionsã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ååˆ†ã«è¨­å®šã—ã¦ãã ã•ã„ï¼ˆæ¨å¥¨: 600ç§’ï¼‰ã€‚

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„ã‚¹ãƒ†ãƒƒãƒ—ã§ç‹¬ç«‹ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€1ã‚¹ãƒ†ãƒƒãƒ—ã®å¤±æ•—ãŒå…¨ä½“ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

4. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**: åŸºæœ¬ã‚¿ã‚¹ã‚¯ã¯è‡ªæ²»ä½“Ã—é–¢ä¿‚æ€§ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§APIè²»ç”¨ã‚’å‰Šæ¸›ã§ãã¾ã™ï¼ˆå°†æ¥ã®æœ€é©åŒ–æ¡ˆï¼‰ã€‚

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: è¿½åŠ è³ªå•ãŒé€ä¿¡ã•ã‚Œãªã„

**åŸå› **: follow_up_questionsãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼

**è§£æ±º**:
```sql
SELECT * FROM follow_up_questions WHERE user_id = '<USER_ID>';
```

### å•é¡Œ: å€‹åˆ¥ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œãªã„

**åŸå› **: ã™ã¹ã¦ã®è¿½åŠ è³ªå•ã«å›ç­”ã—ã¦ã„ãªã„

**è§£æ±º**:
```sql
SELECT question_text, is_answered
FROM follow_up_questions
WHERE user_id = '<USER_ID>' AND is_answered = false;
```

### å•é¡Œ: TipsãŒè¿½åŠ ã•ã‚Œãªã„

**åŸå› **: Step 2ãŒå®Œäº†ã—ã¦ã„ãªã„

**è§£æ±º**:
```sql
SELECT * FROM task_generation_steps
WHERE user_id = '<USER_ID>' AND step_name = 'personalized';
```

---

## ğŸ“ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿèƒ½**: åŸºæœ¬ã‚¿ã‚¹ã‚¯ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
2. **A/Bãƒ†ã‚¹ãƒˆ**: 3ã‚¹ãƒ†ãƒƒãƒ— vs 1ã‚¹ãƒ†ãƒƒãƒ—ã®åŠ¹æœæ¸¬å®š
3. **è³ªå•ã®å‹•çš„ç”Ÿæˆ**: AIãŒåŸºæœ¬ã‚¿ã‚¹ã‚¯ã‚’è¦‹ã¦è¿½åŠ è³ªå•ã‚’è‡ªå‹•ç”Ÿæˆ
4. **Tipså“è³ªãƒ•ã‚£ãƒ«ã‚¿**: åé›†ã—ãŸTipsã®å“è³ªã‚’è©•ä¾¡ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

---

## ã¾ã¨ã‚

ã“ã®çµ±åˆã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¾ã™ï¼š

âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®çŠ¶æ³ã«å®Œå…¨ã«ç‰¹åŒ–ã—ãŸã‚¿ã‚¹ã‚¯ç”Ÿæˆ
âœ… ãƒªã‚¢ãƒ«ãªä½“é¨“è«‡ãƒ»è£æŠ€ã®æä¾›
âœ… ä¸è¦ãªã‚¿ã‚¹ã‚¯ã®å‰Šæ¸›
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ã®å‘ä¸Š

å®Ÿè£…å®Œäº†å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã—ã€ç¶™ç¶šçš„ã«æ”¹å–„ã—ã¦ã„ãã¾ã™ã€‚
