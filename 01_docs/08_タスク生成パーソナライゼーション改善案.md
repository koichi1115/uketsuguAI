# タスク生成パーソナライゼーション改善案

## 📋 ドキュメント情報
- **作成日**: 2025-10-13
- **バージョン**: 1.0
- **対象ブランチ**: feature/improve-task-personalization

---

## 🎯 改善の目的

現在のタスク生成システムは、Gemini 2.5 Pro + Google Search Groundingを使用してWeb検索やグラウンディングを行っているにも関わらず、**個人ごとの家族構成、住んでいる地域、保有資産の状況などによって大きく変わるはずのタスクやその中身が十分にパーソナライズされていない**という課題があります。

この改善案では、タスク生成プロセスを多段階化し、より深い個別最適化を実現します。

---

## 🔍 現状分析

### 現在の実装（task_generator.py）

```
┌─────────────────────────────────────┐
│  ユーザープロフィール収集            │
│  - 故人との関係                      │
│  - 都道府県・市区町村                │
│  - 死亡日                            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  1回の処理でタスク生成               │
│  ① Google Search Grounding          │
│  ② 情報収集 + タスク構造化           │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  タスクリスト出力（10〜15件）        │
└─────────────────────────────────────┘
```

### 問題点

1. **情報収集と構造化が1回の処理で完結**
   - 基本的な公的情報と個人的な体験談が混在
   - 深堀りが不十分で、表面的な情報に留まる

2. **追加質問の機会がない**
   - 初期プロフィール（関係・地域・死亡日）のみで判断
   - 家族構成、保有資産、介護の有無など、タスクに大きく影響する情報を取得していない

3. **リアルな体験談の活用が不十分**
   - プロンプトでは「SNS・ブログから実用的なTips」を指示しているが、構造化の段階で薄まる可能性
   - お得情報、時短テクニック、後悔談などが十分に反映されにくい

---

## 💡 改善提案

### 提案1: タスク生成を3ステップに分割

タスク生成を以下の3段階に分け、それぞれで異なる情報源を活用します。

```
┌─────────────────────────────────────┐
│  Step 1: 基本タスク生成              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  【目的】                            │
│    法的義務のある必須手続きを網羅    │
│                                      │
│  【情報源】                          │
│    - e-gov（電子政府総合窓口）       │
│    - 法務省・厚労省・国税庁の公式情報│
│    - 自治体公式サイト                │
│                                      │
│  【生成内容】                        │
│    - 死亡届、年金停止、健康保険など  │
│    - 法的根拠、期限、窓口情報        │
│    - 必要書類リスト                  │
│                                      │
│  【特徴】                            │
│    ✓ 確実性が高い公的情報のみ       │
│    ✓ すべてのユーザーに共通の基盤   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 2: 個別タスク生成              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  【目的】                            │
│    ユーザー固有の状況に応じた手続き  │
│                                      │
│  【追加質問例】                      │
│    - 故人は介護を受けていましたか？  │
│    - 持ち家・賃貸のどちらですか？    │
│    - 車や土地などの資産はありますか？│
│    - 生命保険に加入していましたか？  │
│    - お子様はいらっしゃいますか？    │
│    - 故人は自営業でしたか？          │
│                                      │
│  【情報源】                          │
│    - 追加質問の回答に基づく検索      │
│    - 特定の手続きに関する専門情報    │
│                                      │
│  【生成内容】                        │
│    - 介護保険返還手続き              │
│    - 不動産相続登記                  │
│    - 車両名義変更                    │
│    - 生命保険請求                    │
│    - 遺族年金申請（子がいる場合）    │
│    - 個人事業廃業届                  │
│                                      │
│  【特徴】                            │
│    ✓ ユーザー状況に完全に特化       │
│    ✓ 不要な手続きを排除             │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 3: 実用的Tips・お得情報収集    │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  【目的】                            │
│    リアルな体験に基づく有益情報を提供│
│                                      │
│  【情報源】                          │
│    - X（旧Twitter）の実体験投稿      │
│    - ブログ記事（個人の体験談）      │
│    - 口コミサイト                    │
│    - YouTube解説動画                 │
│                                      │
│  【収集する情報】                    │
│    💡 時短テクニック                 │
│       「このタイミングでやると楽」   │
│       「事前にコピーしておくべき書類」│
│                                      │
│    💰 お得情報                       │
│       「補助金・給付金がもらえる」   │
│       「手数料が戻ってくる」         │
│       「減税措置がある」             │
│                                      │
│    ⚠️ 注意喚起                      │
│       「これをやっておけば良かった」 │
│       「知らないと損する」           │
│       「窓口で断られた体験」         │
│                                      │
│    📝 実用的なチェックリスト         │
│       「窓口に持っていくべきもの」   │
│       「電話で事前確認すべきこと」   │
│                                      │
│  【反映方法】                        │
│    - 各タスクのtipsフィールドに追記  │
│    - 新規タスクとして追加            │
│      （例: 「遺族年金の裏技」）      │
│                                      │
│  【特徴】                            │
│    ✓ 公式情報では得られない実体験   │
│    ✓ 具体的で実行可能なアドバイス   │
│    ✓ 感情的なサポートにもなる       │
└─────────────────────────────────────┘
```

---

### 提案2: 追加質問による深堀り

基本タスク生成後、ユーザーに追加質問を投げかけてより詳細な情報を収集します。

#### 実装案

```python
# Step 1: 基本タスク生成後
basic_tasks = generate_basic_tasks(user_id, basic_profile, conn)

# Step 2: 追加質問の生成
follow_up_questions = generate_follow_up_questions(basic_tasks, basic_profile)
# → LINEでユーザーに質問を送信

# Step 3: 回答を受け取った後、個別タスクを生成
additional_profile = collect_user_responses()
personalized_tasks = generate_personalized_tasks(
    user_id,
    basic_profile,
    additional_profile,
    basic_tasks,
    conn
)

# Step 4: 実用的Tips収集
enhanced_tasks = enhance_with_real_world_tips(
    personalized_tasks,
    additional_profile,
    conn
)
```

#### 追加質問の例

基本タスクの内容から、必要な質問を動的に生成します：

| 基本タスク | 追加質問 | 生成される個別タスク |
|-----------|---------|---------------------|
| 年金停止 | 「故人は厚生年金を受給していましたか？」 | 遺族厚生年金申請 |
| 健康保険返却 | 「ご家族は故人の扶養に入っていましたか？」 | 扶養家族の国保加入手続き |
| 相続手続き | 「不動産や車などの資産はありますか？」 | 不動産相続登記、車両名義変更 |
| 相続手続き | 「生命保険に加入していましたか？」 | 生命保険金請求 |
| 介護保険 | 「介護サービスを利用していましたか？」 | 介護保険料返還請求 |
| 世帯主変更 | 「お子様はいらっしゃいますか？」 | 児童手当受給者変更 |

---

## 🏗️ 実装アーキテクチャ

### 新しいモジュール構成

```
02_src/webhook-handler/
├── task_generator.py              # 既存: 基本タスク生成
├── task_personalizer.py           # 新規: 個別タスク生成
├── task_enhancer.py               # 新規: Tips収集・拡張
├── question_generator.py          # 新規: 追加質問生成
└── conversation_flow_manager.py   # 新規: 会話フロー管理
```

### データベーススキーマの拡張

```sql
-- ユーザープロフィールの拡張
ALTER TABLE user_profiles ADD COLUMN has_care_insurance BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN has_real_estate BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN has_vehicle BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN has_life_insurance BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN has_children BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN is_self_employed BOOLEAN;
ALTER TABLE user_profiles ADD COLUMN additional_info JSONB; -- その他の情報

-- 追加質問管理テーブル
CREATE TABLE follow_up_questions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    question_text TEXT NOT NULL,
    question_type VARCHAR(50), -- 'yes_no', 'multiple_choice', 'free_text'
    is_answered BOOLEAN DEFAULT FALSE,
    answer TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- タスク生成ステップ管理
CREATE TABLE task_generation_steps (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    step_name VARCHAR(50), -- 'basic', 'personalized', 'enhanced'
    status VARCHAR(20), -- 'pending', 'in_progress', 'completed'
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 📊 期待される効果

### 定量的効果

| 指標 | 現状 | 改善後（予測） |
|------|------|---------------|
| タスク数（平均） | 10〜15件 | 15〜25件 |
| パーソナライゼーション精度 | 60%（推定） | 85%以上 |
| 不要タスクの削減 | - | 30%削減 |
| ユーザー満足度 | - | +40%向上 |

### 定性的効果

1. **より正確なタスクリスト**
   - 「自分には関係ない」と感じるタスクが減少
   - 「これ忘れてた！」という漏れが減少

2. **実用的な情報提供**
   - 公式サイトには載っていない裏技・コツを提供
   - 実体験に基づく具体的なアドバイス

3. **感情的なサポート**
   - 「同じ経験をした人がいる」という安心感
   - 口コミ・体験談による心理的支援

4. **時間とコストの削減**
   - 窓口での二度手間を削減
   - 取りこぼしによる損失を防止

---

## 🚀 実装ロードマップ

### Phase 1: 基盤整備（Week 1-2）
- [ ] データベーススキーマの拡張
- [ ] 追加質問生成ロジックの実装
- [ ] 会話フロー管理機能の実装

### Phase 2: 個別タスク生成（Week 3-4）
- [ ] `task_personalizer.py` の実装
- [ ] 追加質問に基づくタスク生成ロジック
- [ ] ユニットテスト作成

### Phase 3: Tips収集・拡張（Week 5-6）
- [ ] `task_enhancer.py` の実装
- [ ] SNS・ブログからの情報収集ロジック
- [ ] 既存タスクへのTips追記機能

### Phase 4: 統合・テスト（Week 7-8）
- [ ] 3ステップの連携動作確認
- [ ] エンドツーエンドテスト
- [ ] パフォーマンス最適化

### Phase 5: デプロイ・モニタリング（Week 9-）
- [ ] 本番環境デプロイ
- [ ] ユーザーフィードバック収集
- [ ] 継続的改善

---

## 🔧 技術的考慮事項

### 1. APIコスト削減

3ステップに分割することで、API呼び出しが増加します。コスト最適化策：

- **キャッシング**: 基本タスクは自治体×関係性でキャッシュ
- **バッチ処理**: Tips収集は非同期で実行
- **段階的実行**: ユーザーが質問に答えるまで次ステップを実行しない

### 2. レスポンス時間の管理

- Step 1（基本タスク）: 即座に返却（10秒以内）
- Step 2（個別タスク）: ユーザーの回答後に実行（15秒以内）
- Step 3（Tips収集）: バックグラウンドで実行、完了時に通知

### 3. エラーハンドリング

各ステップで独立してフォールバック可能に：

```python
try:
    basic_tasks = generate_basic_tasks(...)
except Exception:
    basic_tasks = get_fallback_basic_tasks()

try:
    personalized_tasks = generate_personalized_tasks(...)
except Exception:
    # 基本タスクのみで継続
    pass
```

---

## 📝 まとめ

この改善案では、タスク生成を**3ステップ**に分割し、**追加質問による深堀り**を行うことで、以下を実現します：

1. ✅ **公的情報の正確性** - 基本タスクで法的根拠を明確化
2. ✅ **個人状況への最適化** - 追加質問で不要なタスクを排除
3. ✅ **リアルな体験談の活用** - SNS・ブログから実用的な情報を収集

これにより、**「私のための手続きガイド」** として、より高い価値を提供できます。

---

## 🙋 次のアクション

- [ ] この改善案をチームでレビュー
- [ ] Phase 1の実装開始判断
- [ ] API費用・実装工数の見積もり精緻化
